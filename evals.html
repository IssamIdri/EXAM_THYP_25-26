<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des Évaluations</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .evals-container {
            display: grid;
            gap: 20px;
            margin-top: 30px;
        }
        .eval-item {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .eval-id {
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
        }
        .eval-note {
            font-size: 1.3em;
            color: #4CAF50;
            font-weight: bold;
            margin: 10px 0;
        }
        .eval-etudiant, .eval-cours {
            color: #333;
            margin: 8px 0;
        }
        .eval-label {
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Liste des Évaluations</h1>
    <div id="evals-container" class="evals-container"></div>
    <div id="loading" style="text-align: center; padding: 20px; color: #666;">Chargement des évaluations...</div>
    <div id="error" style="text-align: center; padding: 20px; color: red; display: none;"></div>

    <script>
        const API_URL = 'api_bdd.php';
        
        // Configuration Omeka S (gardée pour référence)
        const OMEKA_S_URL = 'http://localhost/omk_thyp_25-26_clone';
        const KEY_IDENTITY = 'EI6g2wROVTOiIBHmTf0roMIL647UenRu';
        const KEY_CREDENTIAL = 'JaOh8wKwDo2hTiR66uDjiMGaYoNsCiOj';
        
        async function setEval(evaluationData) {
            try {
                const evalItem = {
                    '@type': 'o:Item',
                    'o:resource_class': {
                        '@id': 'http://example.org/master-eval#Evaluation'
                    },
                    'dcterms:title': [
                        {
                            '@value': evaluationData.titre || `Évaluation ${evaluationData.id}`,
                            '@type': 'http://www.w3.org/2001/XMLSchema#string'
                        }
                    ],
                    'me:concerneEtudiant': [
                        {
                            'o:id': evaluationData.etudiantId
                        }
                    ],
                    'me:concerneCours': [
                        {
                            'o:id': evaluationData.coursId
                        }
                    ],
                    'me:dateEvaluation': [
                        {
                            '@value': evaluationData.date || new Date().toISOString().split('T')[0],
                            '@type': 'http://www.w3.org/2001/XMLSchema#date'
                        }
                    ],
                    'me:coefficient': [
                        {
                            '@value': evaluationData.coefficient || 1.0,
                            '@type': 'http://www.w3.org/2001/XMLSchema#decimal'
                        }
                    ]
                };

                if (evaluationData.note !== undefined) {
                    const noteItem = {
                        '@type': 'o:Item',
                        'o:resource_class': {
                            '@id': 'http://example.org/master-eval#Note'
                        },
                        'me:valeurNote': [
                            {
                                '@value': parseFloat(evaluationData.note),
                                '@type': 'http://www.w3.org/2001/XMLSchema#decimal'
                            }
                        ]
                    };

                    const noteResponse = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'create',
                            endpoint: 'items',
                            data: noteItem
                        })
                    });

                    if (noteResponse.ok) {
                        const noteResult = await noteResponse.json();
                        const noteId = noteResult['o:id'];
                        
                        evalItem['me:aNote'] = [
                            {
                                'o:id': noteId
                            }
                        ];
                    }
                }

                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'create',
                        endpoint: 'items',
                        data: evalItem
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Erreur HTTP: ${response.status} - ${errorData}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Erreur lors de l\'enregistrement de l\'évaluation:', error);
                throw error;
            }
        }

        async function getEvals() {
            try {
                const url = `${API_URL}?endpoint=evals`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    let errorMessage = `Erreur HTTP: ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorData);
                        errorMessage += ' - ' + (errorJson.error || errorJson.message || JSON.stringify(errorJson));
                    } catch (e) {
                        errorMessage += ' - ' + errorData.substring(0, 100);
                    }
                    throw new Error(errorMessage);
                }

                const evals = await response.json();
                
                if (!Array.isArray(evals)) {
                    console.warn('Format de réponse inattendu:', evals);
                    return [];
                }

                console.log(`Évaluations trouvées: ${evals.length}`);
                return evals;
            } catch (error) {
                console.error('Erreur lors de la récupération des évaluations:', error);
                document.getElementById('error').textContent = `Erreur: ${error.message}`;
                document.getElementById('error').style.display = 'block';
                return [];
            }
        }

        async function showEval() {
            const container = document.getElementById('evals-container');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            container.innerHTML = '';
            
            const evals = await getEvals();
            
            loading.style.display = 'none';
            
            if (evals.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Aucune évaluation trouvée.</p>';
                return;
            }
            
            evals.forEach(evalItem => {
                const evalDiv = document.createElement('div');
                evalDiv.className = 'eval-item';
                
                const idDiv = document.createElement('div');
                idDiv.className = 'eval-id';
                idDiv.textContent = `Identifiant: ${evalItem.id}`;
                
                const noteDiv = document.createElement('div');
                noteDiv.className = 'eval-note';
                noteDiv.textContent = `Note: ${evalItem.note !== null && evalItem.note !== undefined ? evalItem.note : 'N/A'}`;
                
                const etudiantDiv = document.createElement('div');
                etudiantDiv.className = 'eval-etudiant';
                const etudiantLabel = document.createElement('span');
                etudiantLabel.className = 'eval-label';
                etudiantLabel.textContent = 'Étudiant: ';
                etudiantDiv.appendChild(etudiantLabel);
                etudiantDiv.appendChild(document.createTextNode(evalItem.etudiant || 'Non spécifié'));
                
                const coursDiv = document.createElement('div');
                coursDiv.className = 'eval-cours';
                const coursLabel = document.createElement('span');
                coursLabel.className = 'eval-label';
                coursLabel.textContent = 'Cours: ';
                coursDiv.appendChild(coursLabel);
                coursDiv.appendChild(document.createTextNode(evalItem.cours || 'Non spécifié'));
                
                // Assembler les éléments
                evalDiv.appendChild(idDiv);
                evalDiv.appendChild(noteDiv);
                evalDiv.appendChild(etudiantDiv);
                evalDiv.appendChild(coursDiv);
                
                container.appendChild(evalDiv);
            });
        }

        // Appeler la fonction d'affichage au chargement de la page
        window.onload = function() {
            showEval();
        };
    </script>
</body>
</html>

